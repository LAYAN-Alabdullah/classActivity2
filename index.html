<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Diriyah โ ุงููุฑุดุฏ ุงูุณูุงุญู ุงูุฐูู</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <header>
    <h1>ุงูุฏุฑุนูุฉ ุฌููุฑุฉ ุงูููููุฉ</h1>
    <p>ูุฑุดุฏ ุณูุงุญู ุฐูู ููุณุงุนุฏุชู ุนูู ุงูุชุฎุทูุท ูุฒูุงุฑุฉ ุญูู ุงูุทุฑูู ููุง ุญููู โจ</p>
  </header>

  <section class="image">
    <img
      src="https://media.istockphoto.com/id/1963259178/photo/diriyah-illuminated-old-town-walls-at-turaif-district-complex-at-night-riyadh-saudi-arabia.jpg?b=1&s=612x612&w=0&k=20&c=q7MwY43lklkPLvK2BMx4lZo2tlJzWBqaHnDQVdk3l-0="
      alt="ุฃุณูุงุฑ ุญู ุงูุทุฑูู โ ุงูุฏุฑุนูุฉ">
  </section>

  <section class="about">
    <h2>ูุจุฐุฉ ุนู ุงูุฏุฑุนูุฉ</h2>
    <p>ุงูุฏุฑุนูุฉ ูู ุงูุนุงุตูุฉ ุงูุชุงุฑูุฎูุฉ ุงูุฃููู ููููููุฉ ุงูุนุฑุจูุฉ ุงูุณุนูุฏูุฉุ ุดูุงู ุบุฑุจู ุงูุฑูุงุถ. ุชุนุฏ ููุฏ ุงูุฏููุฉ ุงูุณุนูุฏูุฉ ุงูุฃูููุ ูุชุถู ุญู ุงูุทุฑูู ุงูููุณุฌูู ูู ูุงุฆูุฉ ุงููููุณูู ููุชุฑุงุซ ุงูุนุงููู.</p>
  </section>

  <section class="tourist-spots">
    <h2>ุฃุจุฑุฒ ุงููุนุงูู ุงูุณูุงุญูุฉ</h2>
    <ul>
      <li>
        <strong>ุญู ุงูุทุฑูู</strong>
        <p>ุนูุงุฑุฉ ุทูููุฉ ูุฌุฏููุฉ ูุฃุฒูุฉ ุถููุฉ ููุตูุฑ ุชุงุฑูุฎูุฉโููุฒ ุชุฑุงุซู ุฃุตูู.</p>
      </li>
      <li>
        <strong>ูุงุฏู ุญูููุฉ</strong>
        <p>ุทุจูุนุฉ ุฎููุงุจุฉ ููุณุงุฑุงุช ูููุดู ูุงููุฒูุงุช.</p>
      </li>
      <li>
        <strong>ูุชุญู ุงูุฏุฑุนูุฉ</strong>
        <p>ููุชููุงุช ููุตุต ุชุฃุณูุณ ุงูุฏููุฉ ุงูุณุนูุฏูุฉ ุงูุฃููู.</p>
      </li>
      <li>
        <strong>ุจูุงุจุฉ ุงูุฏุฑุนูุฉ</strong>
        <p>ูุฏุฎู ุชุงุฑูุฎู ูุนูุณ ูุฎุงูุฉ ุงูุนูุงุฑุฉ ุงููุฌุฏููุฉ.</p>
      </li>
    </ul>
  </section>

  <section class="additional-info">
    <h2>ูุนูููุงุช ุฅุถุงููุฉ</h2>
    <p>ุชูุนุฑู ุงูุฏุฑุนูุฉ ุจุญูุงูุฉ ุงูุถูุงูุฉ ูุงููููุฉ ุงูุณุนูุฏูุฉ. ุชุงุฑูุฎูุง ูุนูุฏ ูููุฑู 15 ููุงูุช ูุฑูุฒูุง ุชุฌุงุฑููุง ูุซูุงูููุง ููููุง ูู ุงูุฌุฒูุฑุฉ ุงูุนุฑุจูุฉ.</p>
  </section>

  <section class="video">
    <h2>ููุฏูู ุนู ุซูุงูุฉ ุงูุฏุฑุนูุฉ</h2>
    <div class="video-frame">
      <iframe width="560" height="315" src="https://www.youtube.com/embed/z_THy2FptGo"
        title="Diriyah โ Culture & Heritage" frameborder="0"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
        allowfullscreen></iframe>
    </div>
  </section>

  <footer>
    <p>ุงูุฏุฑุนูุฉ ุชุฑุญูุจ ุจูู ๐ฟ</p>
  </footer>

  <!-- ุฃููููุฉ ุงููุฑุดุฏ ุงูุณูุงุญู -->
  <button id="ai-icon" aria-label="ูุชุญ ุงููุฑุดุฏ ุงูุณูุงุญู" title="ุงููุฑุดุฏ ุงูุณูุงุญู">๐บ๏ธ</button>

  <!-- ููุญุฉ ุงููุฑุดุฏ -->
  <section class="ai-panel" id="ai-panel" aria-live="polite">
    <div class="ai-header">
      <div class="ai-title">ูุฑุดุฏ ุงูุฏุฑุนูุฉ ุงูุฐูู</div>
      <div class="ai-actions">
        <button class="ai-chip" data-chip="ุงูุชุฑุญ ูู ุฌุฏูู ุฒูุงุฑุฉ 3 ุณุงุนุงุช">ุฌุฏูู 3 ุณุงุนุงุช</button>
        <button class="ai-chip" data-chip="ูุง ุฃูุถู ููุช ูุฒูุงุฑุฉ ุญู ุงูุทุฑููุ">ุฃูุถู ููุช</button>
        <button class="ai-chip" data-chip="ุฏูููู ุนูู ูุทุงุนู ูุฑูุจุฉ ููุนุงุฆูุงุช">ูุทุงุนู ูุฑูุจุฉ</button>
        <button class="ai-close" id="ai-close" aria-label="ุฅุบูุงู">ร</button>
      </div>
    </div>

    <div class="ai-body">
      <div class="ai-suggestions" id="ai-suggestions">
        <button class="sug">ููู ุฃุดุชุฑู ุชุฐุงูุฑ ุญู ุงูุทุฑููุ</button>
        <button class="sug">ุฃูุดุทุฉ ููุฃุทูุงู ูู ุงูุฏุฑุนูุฉ</button>
        <button class="sug">ุฃูุถู ููุงุท ุงูุชุตููุฑ</button>
      </div>

      <div class="chat" id="chat" role="log" aria-live="polite" aria-relevant="additions">
        <!-- ููุงุนุงุช ุงูุฏุฑุฏุดุฉ ุชุธูุฑ ููุง -->
      </div>
    </div>

    <div class="ai-input">
      <button class="btn btn-voice" id="btn-voice" title="ุชุญุฏูุซ ุจุงูุตูุช ๐ค" aria-label="ุจุฏุก/ุฅููุงู ุงูุชุณุฌูู">๐ค</button>
      <textarea id="user-input" placeholder="ุงูุชุจ ุณุคุงูู ููุง..." rows="1"></textarea>
      <button class="btn btn-copy" id="btn-copy" title="ูุณุฎ ุฃุญุฏุซ ุฑุฏ">๐</button>
      <button class="btn btn-send" id="btn-send">ุฅุฑุณุงู</button>
    </div>
  </section>

  <div class="toast" id="toast">ุชู ุงููุณุฎ โ</div>

  <script>
    // ==== ุนูุงุตุฑ DOM
    const panel = document.getElementById('ai-panel');
    const icon = document.getElementById('ai-icon');
    const closeBtn = document.getElementById('ai-close');
    const sendBtn = document.getElementById('btn-send');
    const copyBtn = document.getElementById('btn-copy');
    const voiceBtn = document.getElementById('btn-voice');
    const input = document.getElementById('user-input');
    const chat = document.getElementById('chat');
    const toast = document.getElementById('toast');

    const API_PATH = '/api/tour-guide';
    const STORAGE_KEY = 'diriyah_guide_chat_v1';

    let recognizing = false;
    let recognition = null;
    let lastSentAt = 0;

    // ูุชุญ/ุฅุบูุงู ุงูููุญุฉ
    const togglePanel = (forceOpen=null) => {
      const willOpen = forceOpen ?? !panel.classList.contains('show');
      if (willOpen){
        panel.style.display='flex';
        requestAnimationFrame(()=> panel.classList.add('show'));
        input.focus(); scrollToBottom();
      } else {
        panel.classList.remove('show');
        setTimeout(()=>{ panel.style.display='none'; }, 200);
      }
    };
    icon.addEventListener('click', ()=> togglePanel());
    closeBtn.addEventListener('click', ()=> togglePanel(false));

    // ุงุฎุชุตุงุฑุงุช
    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape' && panel.classList.contains('show')) togglePanel(false);
      if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'enter') sendMessage();
    });

    // ููุงุนุงุช
    function bubble(html, who='bot'){
      const wrap = document.createElement('div');
      wrap.className = `bubble ${who}`;
      wrap.innerHTML = html;
      chat.appendChild(wrap);
      scrollToBottom(); persist();
      return wrap;
    }
    function meta(text, who='bot'){
      const m = document.createElement('div');
      m.className = 'meta';
      m.textContent = text;
      chat.appendChild(m);
      scrollToBottom(); persist();
      return m;
    }
    function typing(){
      const box = document.createElement('div');
      box.className = 'typing bot';
      box.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
      chat.appendChild(box);
      scrollToBottom();
      return box;
    }
    function scrollToBottom(){ chat.parentElement.scrollTop = chat.parentElement.scrollHeight; }

    // ูุณุฎ ุขุฎุฑ ุฑุฏ
    copyBtn.addEventListener('click', ()=>{
      const lastBot = [...chat.querySelectorAll('.bubble.bot')].pop();
      if(!lastBot){ return notify('ูุง ููุฌุฏ ุฑุฏ ููุณุฎู'); }
      navigator.clipboard.writeText(lastBot.innerText).then(()=> notify('ุชู ุงููุณุฎ โ'));
    });
    function notify(text){
      toast.textContent = text;
      toast.classList.add('show');
      setTimeout(()=> toast.classList.remove('show'), 1400);
    }

    // ุงูุชุฑุงุญุงุช ุฌุงูุฒุฉ
    document.querySelectorAll('.sug').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        input.value = btn.textContent.trim();
        sendMessage();
      });
    });
    document.querySelectorAll('.ai-chip').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        input.value = btn.dataset.chip || btn.textContent.trim();
        sendMessage();
      });
    });

    // ุฅุฑุณุงู
    sendBtn.addEventListener('click', sendMessage);
    input.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' && !e.shiftKey){
        e.preventDefault(); sendMessage();
      }
    });

    async function sendMessage(){
      const text = input.value.trim();
      if(!text) { notify('ุงูุชุจ ุณุคุงูู ุฃููุงู'); return; }

      const now = Date.now();
      if(now - lastSentAt < 500) return; lastSentAt = now;

      bubble(escapeHtml(text), 'me');
      meta(timeNow(), 'me');
      const t = typing();

      const history = exportHistoryForApi();

      try{
        const res = await fetch(API_PATH, {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ question: text, history })
        });

        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const answer = (data && (data.answer || data.content || data.message)) || 'ูู ูุตู ุฑุฏ.';

        t.remove();
        bubble(linkify(escapeHtml(answer)), 'bot');
        meta('ุงููุฑุดุฏ โข ' + timeNow(), 'bot');
        input.value=''; persist();
      } catch(err){
        t.remove();
        console.error(err);
        bubble('โ๏ธ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุงุชุตุงู ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู. ุญุงูู ูุงุญููุง ุฃู ุชุญูู ูู ุงูุดุจูุฉ.', 'bot');
        meta('ูุดู ุงูุงุชุตุงู', 'bot');
      }
    }

    // ุตูุช ุฅูู ูุต (ุฅู ูุงู ูุฏุนูู)
    if('webkitSpeechRecognition' in window || 'SpeechRecognition' in window){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SR();
      recognition.lang = 'ar-SA';
      recognition.interimResults = true;
      recognition.continuous = false;

      recognition.onstart = ()=> { recognizing = true; voiceBtn.textContent = 'โน๏ธ'; };
      recognition.onend = ()=> { recognizing = false; voiceBtn.textContent = '๐ค'; };

      recognition.onresult = (e)=>{
        let interim=''; let final='';
        for(let i=0; i<e.results.length; i++){
          const tr = e.results[i][0].transcript;
          if(e.results[i].isFinal) final += tr; else interim += tr;
        }
        input.value = (final || interim).trim();
      };

      voiceBtn.addEventListener('click', ()=>{
        if(!recognizing) recognition.start(); else recognition.stop();
      });
    } else {
      voiceBtn.disabled = true;
      voiceBtn.title = 'ุงูุชุณุฌูู ุงูุตูุชู ุบูุฑ ูุฏุนูู ูู ูุฐุง ุงููุชุตูุญ';
    }

    // ุญูุธ ุงููุญุงุฏุซุฉ ูุญูููุง
    function persist(){
      const items = [...chat.children].map(node=>{
        if(node.classList.contains('bubble')){
          return { t:'bubble', who: node.classList.contains('me') ? 'me':'bot', html: node.innerHTML };
        } else if(node.classList.contains('meta')){
          return { t:'meta', who: node.previousElementSibling?.classList.contains('me') ? 'me':'bot', text: node.textContent };
        } else if(node.classList.contains('typing')){
          return null;
        }
      }).filter(Boolean);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
    }
    function loadPersisted(){
      const json = localStorage.getItem(STORAGE_KEY);
      if(!json) return;
      try{
        const items = JSON.parse(json);
        items.forEach(it=>{
          if(it.t === 'bubble') bubble(it.html, it.who);
          if(it.t === 'meta') meta(it.text, it.who);
        });
      }catch(_){}
    }
    function exportHistoryForApi(){
      const list = [];
      [...chat.querySelectorAll('.bubble')].forEach(b=>{
        const role = b.classList.contains('me') ? 'user' : 'assistant';
        list.push({ role, content: b.innerText.trim() });
      });
      return list.slice(-12);
    }
    loadPersisted();

    // ุฃุฏูุงุช
    function escapeHtml(str){
      return str.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    }
    function linkify(text){
      const urlRe = /(https?:\/\/[^\s]+)/g;
      return text.replace(urlRe, '<a href="$1" target="_blank" rel="noopener">$1</a>');
    }
    function timeNow(){
      try{
        return new Intl.DateTimeFormat('ar-SA',{hour:'2-digit',minute:'2-digit'}).format(new Date());
      }catch{ return new Date().toLocaleTimeString(); }
    }
  </script>
</body>
</html>
