<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Diriyah â€“ Ø§Ù„Ù…Ø±Ø´Ø¯ Ø§Ù„Ø³ÙŠØ§Ø­ÙŠ Ø§Ù„Ø°ÙƒÙŠ</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --brand:#8b5a2b;      /* Ø¨Ù†ÙŠ ØªØ±Ø§Ø«ÙŠ */
      --brand-600:#704621;
      --sand:#fff7ec;       /* Ø®Ù„ÙÙŠØ© Ø±Ù…Ù„ÙŠØ© ÙØ§ØªØ­Ø© */
      --paper:#fffaf4;
      --ink:#2d261f;
      --muted:#8f8a83;
      --ok:#0f8b4c;
      --danger:#b23a2c;
      --shadow:0 10px 30px rgba(0,0,0,.12);
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--sand);color:var(--ink);font-family:'Tajawal',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    img{max-width:100%;height:auto;display:block}

    header{
      padding:20px 16px 8px;
      text-align:center;
    }
    header h1{
      margin:0 0 6px;
      font-size:clamp(22px,3.5vw,34px);
      letter-spacing:.3px;
    }
    header p{margin:0;color:var(--muted);font-size:14px}

    /* Hero image */
    .image{
      padding:8px 16px 0;
    }
    .image .frame{
      position:relative;border-radius:18px;overflow:hidden;box-shadow:var(--shadow);
      border:3px solid rgba(139,90,43,.15)
    }
    .image iframe, .image img{
      width:100%;height:auto;aspect-ratio:16/9;display:block
    }

    section{padding:18px 16px;max-width:1050px;margin:0 auto}
    .about, .tourist-spots, .additional-info, .video{
      background:var(--paper);border:1.5px solid rgba(139,90,43,.18);
      border-radius:18px;box-shadow:0 4px 16px rgba(0,0,0,.06)
    }
    section h2{margin:0 0 10px;font-size:clamp(18px,2.6vw,24px)}
    section p, section li{line-height:1.8}

    .tourist-spots ul{list-style:none;padding:0;margin:0}
    .tourist-spots li{padding:10px 12px;border-top:1px dashed rgba(0,0,0,.06)}
    .tourist-spots li:first-child{border-top:none}
    .tourist-spots strong{color:var(--brand)}

    footer{
      text-align:center;padding:24px 12px;color:var(--muted);font-size:14px
    }

    /* ====== AI Guide ====== */
    #ai-icon{
      position:fixed;inset:auto 16px 16px auto;
      width:64px;height:64px;border-radius:50%;
      background:var(--brand);color:#fff;
      display:flex;align-items:center;justify-content:center;
      font-size:28px;cursor:pointer;box-shadow:var(--shadow);z-index:999;
      transition:transform .2s ease, box-shadow .2s ease;
    }
    #ai-icon:hover{transform:translateY(-2px);box-shadow:0 14px 34px rgba(0,0,0,.16)}
    @media (max-width:540px){#ai-icon{width:56px;height:56px;font-size:24px;right:12px;bottom:12px}}

    .ai-panel{
      position:fixed;right:16px;bottom:92px;width: min(420px, 92vw);
      background:var(--paper);border:2px solid var(--brand);border-radius:18px;
      box-shadow:0 18px 50px rgba(0,0,0,.2);
      display:none;flex-direction:column;overflow:hidden;z-index:1000;
      transform:translateY(20px);opacity:0;transition:opacity .25s ease, transform .25s ease;
      max-height:72vh;
    }
    .ai-panel.show{display:flex;opacity:1;transform:translateY(0)}
    .ai-header{
      display:flex;align-items:center;gap:8px;justify-content:space-between;
      padding:10px 12px;background:linear-gradient(180deg, #8b5a2b, #7a4f27);
      color:#fff
    }
    .ai-title{font-weight:700}
    .ai-actions{display:flex;align-items:center;gap:8px}
    .ai-chip{
      background:rgba(255,255,255,.18);color:#fff;border:none;border-radius:999px;
      padding:6px 10px;font-size:12px;cursor:pointer
    }
    .ai-close{
      background:rgba(0,0,0,.18);border:none;color:#fff;cursor:pointer;
      width:32px;height:32px;border-radius:8px;font-size:18px
    }

    .ai-body{display:flex;flex-direction:column;gap:8px;padding:12px;overflow:auto}
    .ai-suggestions{display:flex;flex-wrap:wrap;gap:8px}
    .ai-suggestions .sug{
      border:1px dashed rgba(139,90,43,.35);background:#fff;border-radius:999px;padding:6px 10px;
      font-size:12px;color:#4b3b2f;cursor:pointer
    }

    .chat{
      display:flex;flex-direction:column;gap:10px;min-height:120px;
    }
    .bubble{
      max-width:85%;padding:10px 12px;border-radius:16px;line-height:1.7;font-size:14px;
      box-shadow:0 6px 14px rgba(0,0,0,.06)
    }
    .me{align-self:flex-end;background:#e7d8c8;border:1px solid rgba(139,90,43,.25)}
    .bot{align-self:flex-start;background:#ffffff;border:1px solid rgba(0,0,0,.08)}
    .meta{font-size:11px;color:var(--muted);margin-top:4px}
    .typing{width:52px;height:30px;border-radius:16px;background:#fff;border:1px solid rgba(0,0,0,.08);display:flex;align-items:center;justify-content:center;gap:4px}
    .dot{width:6px;height:6px;border-radius:50%;background:#b8aea4;animation:blink 1.2s infinite}
    .dot:nth-child(2){animation-delay:.2s}.dot:nth-child(3){animation-delay:.4s}
    @keyframes blink{0%,80%,100%{opacity:.2}40%{opacity:1}}

    .ai-input{
      border-top:1px solid rgba(0,0,0,.08);padding:10px;background:#fff;display:flex;gap:8px;align-items:center
    }
    .ai-input textarea{
      flex:1;resize:none;min-height:42px;max-height:120px;padding:10px;border:1px solid #ddd;border-radius:12px;font-family:inherit
    }
    .btn{
      border:none;border-radius:12px;padding:10px 12px;cursor:pointer;font-weight:700
    }
    .btn-send{background:var(--brand);color:#fff}
    .btn-send:hover{background:var(--brand-600)}
    .btn-voice{background:#f0ece6}
    .btn-copy{background:#f3f3f3}

    .toast{
      position:fixed;left:50%;bottom:16px;transform:translateX(-50%);
      background:#111;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;
      transition:opacity .2s ease;pointer-events:none;z-index:1200;font-size:13px
    }
    .toast.show{opacity:1}

    /* Accessibility focus */
    :focus-visible{outline:3px solid #a7774b;outline-offset:2px}
  </style>
</head>
<body>

  <header>
    <h1>Ø§Ù„Ø¯Ø±Ø¹ÙŠØ© Ø¬ÙˆÙ‡Ø±Ø© Ø§Ù„Ù…Ù…Ù„ÙƒØ©</h1>
    <p>Ù…Ø±Ø´Ø¯ Ø³ÙŠØ§Ø­ÙŠ Ø°ÙƒÙŠ Ù„Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø¹Ù„Ù‰ Ø§Ù„ØªØ®Ø·ÙŠØ· Ù„Ø²ÙŠØ§Ø±Ø© Ø­ÙŠÙ‘ Ø§Ù„Ø·Ø±ÙŠÙ ÙˆÙ…Ø§ Ø­ÙˆÙ„Ù‡ âœ¨</p>
  </header>

  <section class="image">
    <div class="frame">
      <img src="https://media.istockphoto.com/id/1963259178/photo/diriyah-illuminated-old-town-walls-at-turaif-district-complex-at-night-riyadh-saudi-arabia.jpg?b=1&s=612x612&w=0&k=20&c=q7MwY43lklkPLvK2BMx4lZo2tlJzWBqaHnDQVdk3l-0=" alt="Ø£Ø³ÙˆØ§Ø± Ø­ÙŠ Ø§Ù„Ø·Ø±ÙŠÙ â€“ Ø§Ù„Ø¯Ø±Ø¹ÙŠØ©"/>
    </div>
  </section>

  <section class="about">
    <h2>Ù†Ø¨Ø°Ø© Ø¹Ù† Ø§Ù„Ø¯Ø±Ø¹ÙŠØ©</h2>
    <p>Ø§Ù„Ø¯Ø±Ø¹ÙŠØ© Ù‡ÙŠ Ø§Ù„Ø¹Ø§ØµÙ…Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ù„Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©ØŒ Ø´Ù…Ø§Ù„ ØºØ±Ø¨ÙŠ Ø§Ù„Ø±ÙŠØ§Ø¶. ØªØ¹Ø¯ Ù…Ù‡Ø¯ Ø§Ù„Ø¯ÙˆÙ„Ø© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰ØŒ ÙˆØªØ¶Ù… Ø­ÙŠ Ø§Ù„Ø·Ø±ÙŠÙ Ø§Ù„Ù…ÙØ³Ø¬Ù‘Ù„ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙŠÙˆÙ†Ø³ÙƒÙˆ Ù„Ù„ØªØ±Ø§Ø« Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ.</p>
  </section>

  <section class="tourist-spots">
    <h2>Ø£Ø¨Ø±Ø² Ø§Ù„Ù…Ø¹Ø§Ù„Ù… Ø§Ù„Ø³ÙŠØ§Ø­ÙŠØ©</h2>
    <ul>
      <li><strong>Ø­ÙŠ Ø§Ù„Ø·Ø±ÙŠÙ</strong><p>Ø¹Ù…Ø§Ø±Ø© Ø·ÙŠÙ†ÙŠØ© Ù†Ø¬Ø¯ÙŠÙ‘Ø© ÙˆØ£Ø²Ù‚Ø© Ø¶ÙŠÙ‚Ø© ÙˆÙ‚ØµÙˆØ± ØªØ§Ø±ÙŠØ®ÙŠØ©â€”ÙƒÙ†Ø² ØªØ±Ø§Ø«ÙŠ Ø£ØµÙŠÙ„.</p></li>
      <li><strong>ÙˆØ§Ø¯ÙŠ Ø­Ù†ÙŠÙØ©</strong><p>Ø·Ø¨ÙŠØ¹Ø© Ø®Ù„Ù‘Ø§Ø¨Ø© ÙˆÙ…Ø³Ø§Ø±Ø§Øª Ù„Ù„Ù…Ø´ÙŠ ÙˆØ§Ù„Ù†Ø²Ù‡Ø§Øª.</p></li>
      <li><strong>Ù…ØªØ­Ù Ø§Ù„Ø¯Ø±Ø¹ÙŠØ©</strong><p>Ù…Ù‚ØªÙ†ÙŠØ§Øª ÙˆÙ‚ØµØµ ØªØ£Ø³ÙŠØ³ Ø§Ù„Ø¯ÙˆÙ„Ø© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰.</p></li>
      <li><strong>Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯Ø±Ø¹ÙŠØ©</strong><p>Ù…Ø¯Ø®Ù„ ØªØ§Ø±ÙŠØ®ÙŠ ÙŠØ¹ÙƒØ³ ÙØ®Ø§Ù…Ø© Ø§Ù„Ø¹Ù…Ø§Ø±Ø© Ø§Ù„Ù†Ø¬Ø¯ÙŠÙ‘Ø©.</p></li>
    </ul>
  </section>

  <section class="additional-info">
    <h2>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</h2>
    <p>ØªÙØ¹Ø±Ù Ø§Ù„Ø¯Ø±Ø¹ÙŠØ© Ø¨Ø­ÙØ§ÙˆØ© Ø§Ù„Ø¶ÙŠØ§ÙØ© ÙˆØ§Ù„Ù‚Ù‡ÙˆØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©. ØªØ§Ø±ÙŠØ®Ù‡Ø§ ÙŠØ¹ÙˆØ¯ Ù„Ù„Ù‚Ø±Ù† 15 ÙˆÙƒØ§Ù†Øª Ù…Ø±ÙƒØ²Ù‹Ø§ ØªØ¬Ø§Ø±ÙŠÙ‹Ø§ ÙˆØ«Ù‚Ø§ÙÙŠÙ‹Ø§ Ù…Ù‡Ù…Ù‹Ø§ ÙÙŠ Ø§Ù„Ø¬Ø²ÙŠØ±Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©.</p>
  </section>

  <section class="video">
    <h2>ÙÙŠØ¯ÙŠÙˆ Ø¹Ù† Ø«Ù‚Ø§ÙØ© Ø§Ù„Ø¯Ø±Ø¹ÙŠØ©</h2>
    <div class="frame">
      <iframe width="560" height="315" src="https://www.youtube.com/embed/z_THy2FptGo"
        title="Diriyah â€“ Culture & Heritage" frameborder="0"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
        allowfullscreen></iframe>
    </div>
  </section>

  <footer>
    <p>Ø§Ù„Ø¯Ø±Ø¹ÙŠØ© ØªØ±Ø­Ù‘Ø¨ Ø¨ÙƒÙ… ğŸŒ¿</p>
  </footer>

  <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ø±Ø´Ø¯ Ø§Ù„Ø³ÙŠØ§Ø­ÙŠ -->
  <button id="ai-icon" aria-label="ÙØªØ­ Ø§Ù„Ù…Ø±Ø´Ø¯ Ø§Ù„Ø³ÙŠØ§Ø­ÙŠ" title="Ø§Ù„Ù…Ø±Ø´Ø¯ Ø§Ù„Ø³ÙŠØ§Ø­ÙŠ">ğŸ—ºï¸</button>

  <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø±Ø´Ø¯ -->
  <section class="ai-panel" id="ai-panel" aria-live="polite">
    <div class="ai-header">
      <div class="ai-title">Ù…Ø±Ø´Ø¯ Ø§Ù„Ø¯Ø±Ø¹ÙŠØ© Ø§Ù„Ø°ÙƒÙŠ</div>
      <div class="ai-actions">
        <button class="ai-chip" data-chip="Ø§Ù‚ØªØ±Ø­ Ù„ÙŠ Ø¬Ø¯ÙˆÙ„ Ø²ÙŠØ§Ø±Ø© 3 Ø³Ø§Ø¹Ø§Øª">Ø¬Ø¯ÙˆÙ„ 3 Ø³Ø§Ø¹Ø§Øª</button>
        <button class="ai-chip" data-chip="Ù…Ø§ Ø£ÙØ¶Ù„ ÙˆÙ‚Øª Ù„Ø²ÙŠØ§Ø±Ø© Ø­ÙŠ Ø§Ù„Ø·Ø±ÙŠÙØŸ">Ø£ÙØ¶Ù„ ÙˆÙ‚Øª</button>
        <button class="ai-chip" data-chip="Ø¯Ù„Ù‘Ù†ÙŠ Ø¹Ù„Ù‰ Ù…Ø·Ø§Ø¹Ù… Ù‚Ø±ÙŠØ¨Ø© Ù„Ù„Ø¹Ø§Ø¦Ù„Ø§Øª">Ù…Ø·Ø§Ø¹Ù… Ù‚Ø±ÙŠØ¨Ø©</button>
        <button class="ai-close" id="ai-close" aria-label="Ø¥ØºÙ„Ø§Ù‚">Ã—</button>
      </div>
    </div>

    <div class="ai-body">
      <div class="ai-suggestions" id="ai-suggestions">
        <button class="sug">ÙƒÙŠÙ Ø£Ø´ØªØ±ÙŠ ØªØ°Ø§ÙƒØ± Ø­ÙŠ Ø§Ù„Ø·Ø±ÙŠÙØŸ</button>
        <button class="sug">Ø£Ù†Ø´Ø·Ø© Ù„Ù„Ø£Ø·ÙØ§Ù„ ÙÙŠ Ø§Ù„Ø¯Ø±Ø¹ÙŠØ©</button>
        <button class="sug">Ø£ÙØ¶Ù„ Ù†Ù‚Ø§Ø· Ø§Ù„ØªØµÙˆÙŠØ±</button>
      </div>

      <div class="chat" id="chat" role="log" aria-live="polite" aria-relevant="additions">
        <!-- ÙÙ‚Ø§Ø¹Ø§Øª Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
      </div>
    </div>

    <div class="ai-input">
      <button class="btn btn-voice" id="btn-voice" title="ØªØ­Ø¯Ù‘Ø« Ø¨Ø§Ù„ØµÙˆØª ğŸ¤" aria-label="Ø¨Ø¯Ø¡/Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„">ğŸ¤</button>
      <textarea id="user-input" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§..." rows="1"></textarea>
      <button class="btn btn-copy" id="btn-copy" title="Ù†Ø³Ø® Ø£Ø­Ø¯Ø« Ø±Ø¯">ğŸ“‹</button>
      <button class="btn btn-send" id="btn-send">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>
  </section>

  <div class="toast" id="toast">ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ…</div>

  <script>
    // ==== Ø¹Ù†Ø§ØµØ± DOM
    const panel = document.getElementById('ai-panel');
    const icon = document.getElementById('ai-icon');
    const closeBtn = document.getElementById('ai-close');
    const sendBtn = document.getElementById('btn-send');
    const copyBtn = document.getElementById('btn-copy');
    const voiceBtn = document.getElementById('btn-voice');
    const input = document.getElementById('user-input');
    const chat = document.getElementById('chat');
    const toast = document.getElementById('toast');

    const API_PATH = '/api/tour-guide';
    const STORAGE_KEY = 'diriyah_guide_chat_v1';

    // ==== Ø­Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ
    let recognizing = false;
    let recognition = null;

    // ==== ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù„ÙˆØ­Ø© Ù…Ø¹ Ø­Ø±ÙƒØ©
    const togglePanel = (forceOpen=null) => {
      const willOpen = forceOpen ?? !panel.classList.contains('show');
      if (willOpen){
        panel.style.display='flex';
        requestAnimationFrame(()=> panel.classList.add('show'));
        input.focus();
        scrollToBottom();
      } else {
        panel.classList.remove('show');
        setTimeout(()=>{ panel.style.display='none'; }, 200);
      }
    };

    icon.addEventListener('click', ()=> togglePanel());
    closeBtn.addEventListener('click', ()=> togglePanel(false));

    // Ø¥ØºÙ„Ø§Ù‚ Ø¨Ø§Ù„Ù‡Ø±ÙˆØ¨ Esc
    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape' && panel.classList.contains('show')) togglePanel(false);
      if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'enter') sendMessage();
    });

    // ==== ÙÙ‚Ø§Ø¹Ø§Øª Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
    function bubble(html, who='bot'){
      const wrap = document.createElement('div');
      wrap.className = `bubble ${who}`;
      wrap.innerHTML = html;
      chat.appendChild(wrap);
      scrollToBottom();
      persist();
      return wrap;
    }
    function meta(text, who='bot'){
      const m = document.createElement('div');
      m.className = 'meta';
      m.textContent = text;
      chat.appendChild(m);
      scrollToBottom();
      persist();
      return m;
    }
    function typing(){
      const box = document.createElement('div');
      box.className = 'typing bot';
      box.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
      chat.appendChild(box);
      scrollToBottom();
      return box;
    }
    function scrollToBottom(){ chat.parentElement.scrollTop = chat.parentElement.scrollHeight; }

    // ==== Ù†Ø³Ø® Ø¢Ø®Ø± Ø±Ø¯
    copyBtn.addEventListener('click', ()=>{
      const lastBot = [...chat.querySelectorAll('.bubble.bot')].pop();
      if(!lastBot){ return notify('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø¯ Ù„Ù†Ø³Ø®Ù‡'); }
      navigator.clipboard.writeText(lastBot.innerText).then(()=> notify('ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ…'));
    });
    function notify(text){
      toast.textContent = text;
      toast.classList.add('show');
      setTimeout(()=> toast.classList.remove('show'), 1400);
    }

    // ==== Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ùˆ Chips
    document.querySelectorAll('.sug').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        input.value = btn.textContent.trim();
        sendMessage();
      });
    });
    document.querySelectorAll('.ai-chip').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        input.value = btn.dataset.chip || btn.textContent.trim();
        sendMessage();
      });
    });

    // ==== Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    let lastSentAt = 0;
    sendBtn.addEventListener('click', sendMessage);
    input.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' && !e.shiftKey){
        e.preventDefault();
        sendMessage();
      }
    });

    async function sendMessage(){
      const text = input.value.trim();
      if(!text) { notify('Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ø£ÙˆÙ„Ø§Ù‹'); return; }

      // Rate limit Ø¨Ø³ÙŠØ· (Ù†ØµÙ Ø«Ø§Ù†ÙŠØ©)
      const now = Date.now();
      if(now - lastSentAt < 500) return; lastSentAt = now;

      // Ø£Ø¸Ù‡Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      bubble(escapeHtml(text), 'me');
      meta(timeNow(), 'me');

      // Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø©
      const t = typing();

      // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø­Ù…ÙˆÙ„Ø© Ù…Ø¹ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù„Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ø°ÙƒØ§Ø¡
      const history = exportHistoryForApi();

      try{
        const res = await fetch(API_PATH, {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ question: text, history })
        });

        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const answer = (data && (data.answer || data.content || data.message)) || 'Ù„Ù… ÙŠØµÙ„ Ø±Ø¯.';

        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ø´Ø± ÙˆØ§Ø¸Ù‡Ø§Ø± Ø§Ù„Ø±Ø¯
        t.remove();
        bubble(linkify(escapeHtml(answer)), 'bot');
        meta('Ø§Ù„Ù…Ø±Ø´Ø¯ â€¢ ' + timeNow(), 'bot');
        input.value='';
        persist();
      } catch(err){
        t.remove();
        console.error(err);
        bubble('âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ. Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø£Ùˆ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø´Ø¨ÙƒØ©.', 'bot');
        meta('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„', 'bot');
      }
    }

    // ==== ØµÙˆØª Ø¥Ù„Ù‰ Ù†Øµ (Web Speech API Ø¥Ø°Ø§ Ù…ØªØ§Ø­)
    if('webkitSpeechRecognition' in window || 'SpeechRecognition' in window){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SR();
      recognition.lang = 'ar-SA';
      recognition.interimResults = true;
      recognition.continuous = false;

      recognition.onstart = ()=> { recognizing = true; voiceBtn.textContent = 'â¹ï¸'; };
      recognition.onend = ()=> { recognizing = false; voiceBtn.textContent = 'ğŸ¤'; };

      recognition.onresult = (e)=>{
        let interim=''; let final='';
        for(let i=0; i<e.results.length; i++){
          const tr = e.results[i][0].transcript;
          if(e.results[i].isFinal) final += tr; else interim += tr;
        }
        input.value = (final || interim).trim();
      };

      voiceBtn.addEventListener('click', ()=>{
        if(!recognizing) recognition.start(); else recognition.stop();
      });
    } else {
      voiceBtn.disabled = true;
      voiceBtn.title = 'Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­';
    }

    // ==== ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§ (LocalStorage)
    function persist(){
      const items = [...chat.children].map(node=>{
        if(node.classList.contains('bubble')){
          return { t:'bubble', who: node.classList.contains('me') ? 'me':'bot', html: node.innerHTML };
        } else if(node.classList.contains('meta')){
          return { t:'meta', who: node.previousElementSibling?.classList.contains('me') ? 'me':'bot', text: node.textContent };
        } else if(node.classList.contains('typing')){
          return null;
        }
      }).filter(Boolean);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
    }
    function loadPersisted(){
      const json = localStorage.getItem(STORAGE_KEY);
      if(!json) return;
      try{
        const items = JSON.parse(json);
        items.forEach(it=>{
          if(it.t === 'bubble') bubble(it.html, it.who);
          if(it.t === 'meta') meta(it.text, it.who);
        });
      }catch(_){}
    }
    function exportHistoryForApi(){
      // ÙŠØ­ÙˆÙ„ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø´Ø§Øª Ø¥Ù„Ù‰ Ø³Ø¬Ù„ Ù…Ø¨Ø³Ø· Ù„Ù„Ù€ backend
      const list = [];
      [...chat.querySelectorAll('.bubble')].forEach(b=>{
        const role = b.classList.contains('me') ? 'user' : 'assistant';
        list.push({ role, content: b.innerText.trim() });
      });
      return list.slice(-12); // Ø¢Ø®Ø± 12 Ø±Ø³Ø§Ù„Ø© ØªÙƒÙÙŠ Ø¹Ø§Ø¯Ø©
    }
    loadPersisted();

    // ==== Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø©
    function escapeHtml(str){
      return str.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    }
    function linkify(text){
      const urlRe = /(https?:\/\/[^\s]+)/g;
      return text.replace(urlRe, '<a href="$1" target="_blank" rel="noopener">$1</a>');
    }
    function timeNow(){
      try{
        return new Intl.DateTimeFormat('ar-SA',{hour:'2-digit',minute:'2-digit'}).format(new Date());
      }catch{ return new Date().toLocaleTimeString(); }
    }

    // Ø§ÙØªØ­ Ø§Ù„Ù„ÙˆØ­Ø© Ø£ÙˆÙ„ Ù…Ø±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    // togglePanel(true);
  </script>
</body>
</html>
