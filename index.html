<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Diriyah – المرشد السياحي الذكي</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <header>
    <h1>الدرعية جوهرة المملكة</h1>
    <p>مرشد سياحي ذكي لمساعدتك على التخطيط لزيارة حيّ الطريف وما حوله ✨</p>
  </header>

  <section class="image">
    <img
      src="https://media.istockphoto.com/id/1963259178/photo/diriyah-illuminated-old-town-walls-at-turaif-district-complex-at-night-riyadh-saudi-arabia.jpg?b=1&s=612x612&w=0&k=20&c=q7MwY43lklkPLvK2BMx4lZo2tlJzWBqaHnDQVdk3l-0="
      alt="أسوار حي الطريف – الدرعية">
  </section>

  <section class="about">
    <h2>نبذة عن الدرعية</h2>
    <p>الدرعية هي العاصمة التاريخية الأولى للمملكة العربية السعودية، شمال غربي الرياض. تعد مهد الدولة السعودية الأولى، وتضم حي الطريف المُسجّل في قائمة اليونسكو للتراث العالمي.</p>
  </section>

  <section class="tourist-spots">
    <h2>أبرز المعالم السياحية</h2>
    <ul>
      <li>
        <strong>حي الطريف</strong>
        <p>عمارة طينية نجديّة وأزقة ضيقة وقصور تاريخية—كنز تراثي أصيل.</p>
      </li>
      <li>
        <strong>وادي حنيفة</strong>
        <p>طبيعة خلّابة ومسارات للمشي والنزهات.</p>
      </li>
      <li>
        <strong>متحف الدرعية</strong>
        <p>مقتنيات وقصص تأسيس الدولة السعودية الأولى.</p>
      </li>
      <li>
        <strong>بوابة الدرعية</strong>
        <p>مدخل تاريخي يعكس فخامة العمارة النجديّة.</p>
      </li>
    </ul>
  </section>

  <section class="additional-info">
    <h2>معلومات إضافية</h2>
    <p>تُعرف الدرعية بحفاوة الضيافة والقهوة السعودية. تاريخها يعود للقرن 15 وكانت مركزًا تجاريًا وثقافيًا مهمًا في الجزيرة العربية.</p>
  </section>

  <section class="video">
    <h2>فيديو عن ثقافة الدرعية</h2>
    <div class="video-frame">
      <iframe width="560" height="315" src="https://www.youtube.com/embed/z_THy2FptGo"
        title="Diriyah – Culture & Heritage" frameborder="0"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
        allowfullscreen></iframe>
    </div>
  </section>

  <footer>
    <p>الدرعية ترحّب بكم 🌿</p>
  </footer>

  <!-- أيقونة المرشد السياحي -->
  <button id="ai-icon" aria-label="فتح المرشد السياحي" title="المرشد السياحي">🗺️</button>

  <!-- لوحة المرشد -->
  <section class="ai-panel" id="ai-panel" aria-live="polite">
    <div class="ai-header">
      <div class="ai-title">مرشد الدرعية الذكي</div>
      <div class="ai-actions">
        <button class="ai-chip" data-chip="اقترح لي جدول زيارة 3 ساعات">جدول 3 ساعات</button>
        <button class="ai-chip" data-chip="ما أفضل وقت لزيارة حي الطريف؟">أفضل وقت</button>
        <button class="ai-chip" data-chip="دلّني على مطاعم قريبة للعائلات">مطاعم قريبة</button>
        <button class="ai-close" id="ai-close" aria-label="إغلاق">×</button>
      </div>
    </div>

    <div class="ai-body">
      <div class="ai-suggestions" id="ai-suggestions">
        <button class="sug">كيف أشتري تذاكر حي الطريف؟</button>
        <button class="sug">أنشطة للأطفال في الدرعية</button>
        <button class="sug">أفضل نقاط التصوير</button>
      </div>

      <div class="chat" id="chat" role="log" aria-live="polite" aria-relevant="additions">
        <!-- فقاعات الدردشة تظهر هنا -->
      </div>
    </div>

    <div class="ai-input">
      <button class="btn btn-voice" id="btn-voice" title="تحدّث بالصوت 🎤" aria-label="بدء/إيقاف التسجيل">🎤</button>
      <textarea id="user-input" placeholder="اكتب سؤالك هنا..." rows="1"></textarea>
      <button class="btn btn-copy" id="btn-copy" title="نسخ أحدث رد">📋</button>
      <button class="btn btn-send" id="btn-send">إرسال</button>
    </div>
  </section>

  <div class="toast" id="toast">تم النسخ ✅</div>

  <script>
    // ==== عناصر DOM
    const panel = document.getElementById('ai-panel');
    const icon = document.getElementById('ai-icon');
    const closeBtn = document.getElementById('ai-close');
    const sendBtn = document.getElementById('btn-send');
    const copyBtn = document.getElementById('btn-copy');
    const voiceBtn = document.getElementById('btn-voice');
    const input = document.getElementById('user-input');
    const chat = document.getElementById('chat');
    const toast = document.getElementById('toast');

    const API_PATH = '/api/tour-guide';
    const STORAGE_KEY = 'diriyah_guide_chat_v1';

    let recognizing = false;
    let recognition = null;
    let lastSentAt = 0;

    // فتح/إغلاق اللوحة
    const togglePanel = (forceOpen=null) => {
      const willOpen = forceOpen ?? !panel.classList.contains('show');
      if (willOpen){
        panel.style.display='flex';
        requestAnimationFrame(()=> panel.classList.add('show'));
        input.focus(); scrollToBottom();
      } else {
        panel.classList.remove('show');
        setTimeout(()=>{ panel.style.display='none'; }, 200);
      }
    };
    icon.addEventListener('click', ()=> togglePanel());
    closeBtn.addEventListener('click', ()=> togglePanel(false));

    // اختصارات
    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape' && panel.classList.contains('show')) togglePanel(false);
      if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'enter') sendMessage();
    });

    // فقاعات
    function bubble(html, who='bot'){
      const wrap = document.createElement('div');
      wrap.className = `bubble ${who}`;
      wrap.innerHTML = html;
      chat.appendChild(wrap);
      scrollToBottom(); persist();
      return wrap;
    }
    function meta(text, who='bot'){
      const m = document.createElement('div');
      m.className = 'meta';
      m.textContent = text;
      chat.appendChild(m);
      scrollToBottom(); persist();
      return m;
    }
    function typing(){
      const box = document.createElement('div');
      box.className = 'typing bot';
      box.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
      chat.appendChild(box);
      scrollToBottom();
      return box;
    }
    function scrollToBottom(){ chat.parentElement.scrollTop = chat.parentElement.scrollHeight; }

    // نسخ آخر رد
    copyBtn.addEventListener('click', ()=>{
      const lastBot = [...chat.querySelectorAll('.bubble.bot')].pop();
      if(!lastBot){ return notify('لا يوجد رد لنسخه'); }
      navigator.clipboard.writeText(lastBot.innerText).then(()=> notify('تم النسخ ✅'));
    });
    function notify(text){
      toast.textContent = text;
      toast.classList.add('show');
      setTimeout(()=> toast.classList.remove('show'), 1400);
    }

    // اقتراحات جاهزة
    document.querySelectorAll('.sug').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        input.value = btn.textContent.trim();
        sendMessage();
      });
    });
    document.querySelectorAll('.ai-chip').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        input.value = btn.dataset.chip || btn.textContent.trim();
        sendMessage();
      });
    });

    // إرسال
    sendBtn.addEventListener('click', sendMessage);
    input.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' && !e.shiftKey){
        e.preventDefault(); sendMessage();
      }
    });

    async function sendMessage(){
      const text = input.value.trim();
      if(!text) { notify('اكتب سؤالك أولاً'); return; }

      const now = Date.now();
      if(now - lastSentAt < 500) return; lastSentAt = now;

      bubble(escapeHtml(text), 'me');
      meta(timeNow(), 'me');
      const t = typing();

      const history = exportHistoryForApi();

      try{
        const res = await fetch(API_PATH, {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ question: text, history })
        });

        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const answer = (data && (data.answer || data.content || data.message)) || 'لم يصل رد.';

        t.remove();
        bubble(linkify(escapeHtml(answer)), 'bot');
        meta('المرشد • ' + timeNow(), 'bot');
        input.value=''; persist();
      } catch(err){
        t.remove();
        console.error(err);
        bubble('⚠️ حدث خطأ أثناء الاتصال بالذكاء الاصطناعي. حاول لاحقًا أو تحقق من الشبكة.', 'bot');
        meta('فشل الاتصال', 'bot');
      }
    }

    // صوت إلى نص (إن كان مدعوم)
    if('webkitSpeechRecognition' in window || 'SpeechRecognition' in window){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SR();
      recognition.lang = 'ar-SA';
      recognition.interimResults = true;
      recognition.continuous = false;

      recognition.onstart = ()=> { recognizing = true; voiceBtn.textContent = '⏹️'; };
      recognition.onend = ()=> { recognizing = false; voiceBtn.textContent = '🎤'; };

      recognition.onresult = (e)=>{
        let interim=''; let final='';
        for(let i=0; i<e.results.length; i++){
          const tr = e.results[i][0].transcript;
          if(e.results[i].isFinal) final += tr; else interim += tr;
        }
        input.value = (final || interim).trim();
      };

      voiceBtn.addEventListener('click', ()=>{
        if(!recognizing) recognition.start(); else recognition.stop();
      });
    } else {
      voiceBtn.disabled = true;
      voiceBtn.title = 'التسجيل الصوتي غير مدعوم في هذا المتصفح';
    }

    // حفظ المحادثة محليًا
    function persist(){
      const items = [...chat.children].map(node=>{
        if(node.classList.contains('bubble')){
          return { t:'bubble', who: node.classList.contains('me') ? 'me':'bot', html: node.innerHTML };
        } else if(node.classList.contains('meta')){
          return { t:'meta', who: node.previousElementSibling?.classList.contains('me') ? 'me':'bot', text: node.textContent };
        } else if(node.classList.contains('typing')){
          return null;
        }
      }).filter(Boolean);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
    }
    function loadPersisted(){
      const json = localStorage.getItem(STORAGE_KEY);
      if(!json) return;
      try{
        const items = JSON.parse(json);
        items.forEach(it=>{
          if(it.t === 'bubble') bubble(it.html, it.who);
          if(it.t === 'meta') meta(it.text, it.who);
        });
      }catch(_){}
    }
    function exportHistoryForApi(){
      const list = [];
      [...chat.querySelectorAll('.bubble')].forEach(b=>{
        const role = b.classList.contains('me') ? 'user' : 'assistant';
        list.push({ role, content: b.innerText.trim() });
      });
      return list.slice(-12);
    }
    loadPersisted();

    // أدوات
    function escapeHtml(str){
      return str.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    }
    function linkify(text){
      const urlRe = /(https?:\/\/[^\s]+)/g;
      return text.replace(urlRe, '<a href="$1" target="_blank" rel="noopener">$1</a>');
    }
    function timeNow(){
      try{
        return new Intl.DateTimeFormat('ar-SA',{hour:'2-digit',minute:'2-digit'}).format(new Date());
      }catch{ return new Date().toLocaleTimeString(); }
    }
  </script>
</body>
</html>
